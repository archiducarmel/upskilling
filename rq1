-- ============================================================================
-- REQUÃŠTE SQL : Extraction des opÃ©rations bancaires transactionnelles
-- Application : Record PDO (ProbabilitÃ© de DÃ©faut)
-- Niveau : Commentaires pour dÃ©butants
-- ============================================================================

-- ============================================================================
-- ğŸ“š CONCEPT CLÃ‰ : QU'EST-CE QU'UN "WITH" (CTE - Common Table Expression) ?
-- ============================================================================
-- Un "WITH" permet de crÃ©er une "table temporaire" qu'on peut rÃ©utiliser
-- dans la requÃªte principale. C'est comme crÃ©er une variable intermÃ©diaire.
-- 
-- Structure :
--   WITH nom_table_temporaire AS (
--       SELECT ...
--   )
--   SELECT * FROM nom_table_temporaire
-- ============================================================================


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ Ã‰TAPE 1 : CrÃ©ation de la premiÃ¨re table temporaire "operations_transformed"â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

WITH operations_transformed AS (
    
    SELECT 
        -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        -- â”‚ "*" signifie "toutes les colonnes" des tables jointes               â”‚
        -- â”‚ On rÃ©cupÃ¨re TOUTES les colonnes existantes (environ 70 colonnes)    â”‚
        -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        *,
        
        -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        -- â”‚ EXTRACTION DE L'ANNÃ‰E                                               â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ YEAR(extract_date) : Extrait l'annÃ©e d'une date                     â”‚
        -- â”‚   Exemple : YEAR('2024-03-15') â†’ 2024                               â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ CAST(... AS VARCHAR) : Convertit un nombre en texte                 â”‚
        -- â”‚   Exemple : CAST(2024 AS VARCHAR) â†’ "2024"                          â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ AS year : Donne un nom Ã  cette nouvelle colonne                     â”‚
        -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        CAST(YEAR(extract_date) AS VARCHAR) AS year,
        
        -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        -- â”‚ EXTRACTION DU MOIS                                                  â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ MONTH(extract_date) : Extrait le mois (1 Ã  12)                      â”‚
        -- â”‚   Exemple : MONTH('2024-03-15') â†’ 3                                 â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ RÃ©sultat : "3" (sans le zÃ©ro devant)                                â”‚
        -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        CAST(MONTH(extract_date) AS VARCHAR) AS month,
        
        -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        -- â”‚ EXTRACTION DU JOUR                                                  â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ DAY(extract_date) : Extrait le jour du mois (1 Ã  31)                â”‚
        -- â”‚   Exemple : DAY('2024-03-15') â†’ 15                                  â”‚
        -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        CAST(DAY(extract_date) AS VARCHAR) AS day,
        
        -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        -- â”‚ MOIS AVEC ZÃ‰RO DEVANT (format "01", "02", ... "12")                 â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ LPAD = "Left PAD" = Ajouter des caractÃ¨res Ã  GAUCHE                 â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ LPAD(texte, longueur_finale, caractÃ¨re_de_remplissage)              â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ Exemples :                                                          â”‚
        -- â”‚   LPAD("3", 2, '0')  â†’ "03"  (on ajoute 1 zÃ©ro Ã  gauche)           â”‚
        -- â”‚   LPAD("12", 2, '0') â†’ "12"  (dÃ©jÃ  2 caractÃ¨res, rien Ã  ajouter)   â”‚
        -- â”‚   LPAD("5", 2, '0')  â†’ "05"                                         â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ Utile pour avoir un format cohÃ©rent : 01, 02, 03... au lieu de 1,2,3â”‚
        -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        LPAD(CAST(MONTH(extract_date) AS VARCHAR(4)), 2, '0') AS month_padded,
        
        -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        -- â”‚ CRÃ‰ATION D'UN IDENTIFIANT "ANNÃ‰E-MOIS" (ex: "202403")               â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ CONCAT = ConcatÃ©ner = Coller des textes bout Ã  bout                 â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ Exemple pour la date '2024-03-15' :                                 â”‚
        -- â”‚   - CAST(YEAR(...) AS VARCHAR(4)) â†’ "2024"                          â”‚
        -- â”‚   - LPAD(CAST(MONTH(...) AS VARCHAR(2)), 2, '0') â†’ "03"             â”‚
        -- â”‚   - CONCAT("2024", "03") â†’ "202403"                                 â”‚
        -- â”‚                                                                      â”‚
        -- â”‚ Ce format permet de trier chronologiquement les mois :              â”‚
        -- â”‚   "202401" < "202402" < "202403" < ... < "202412" < "202501"        â”‚
        -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        CONCAT(
            CAST(YEAR(extract_date) AS VARCHAR(4)),           -- "2024"
            LPAD(CAST(MONTH(extract_date) AS VARCHAR(2)), 2, '0')  -- "03"
        ) AS month_year,  -- RÃ©sultat : "202403"
        
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ FROM : D'oÃ¹ viennent les donnÃ©es ?                                      â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ "cat_ap80414_ice"."ap00325_refined_view"."v_hsta92b0_detail"            â”‚
    -- â”‚  â””â”€â”€ catalogue â”€â”€â”˜ â””â”€â”€â”€â”€â”€ schÃ©ma â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€ table â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ C'est comme un chemin de fichier : dossier/sous-dossier/fichier         â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Cette table contient les MOUVEMENTS BANCAIRES (opÃ©rations sur comptes)  â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ "O" est un ALIAS (surnom) pour cette table. Au lieu d'Ã©crire le nom     â”‚
    -- â”‚ complet Ã  chaque fois, on Ã©crit juste "O"                               â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    FROM "cat_ap80414_ice"."ap00325_refined_view"."v_hsta92b0_detail" O
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ INNER JOIN : Fusion de deux tables                                      â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ On "relie" la table des opÃ©rations (O) avec la table des comptes (A)    â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ INNER JOIN = On ne garde QUE les lignes qui existent dans LES DEUX      â”‚
    -- â”‚              tables (intersection)                                       â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Visualisation :                                                         â”‚
    -- â”‚                                                                          â”‚
    -- â”‚   Table O (OpÃ©rations)     Table A (Comptes)                            â”‚
    -- â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    -- â”‚   â”‚ compte â”‚ montantâ”‚      â”‚ compte â”‚ client â”‚                          â”‚
    -- â”‚   â”‚   A    â”‚  100   â”‚      â”‚   A    â”‚  CLI1  â”‚                          â”‚
    -- â”‚   â”‚   B    â”‚  200   â”‚      â”‚   C    â”‚  CLI2  â”‚                          â”‚
    -- â”‚   â”‚   A    â”‚  150   â”‚      â”‚   A    â”‚  CLI1  â”‚                          â”‚
    -- â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
    -- â”‚                                                                          â”‚
    -- â”‚   RÃ©sultat INNER JOIN (seulement compte A, prÃ©sent dans les 2) :        â”‚
    -- â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
    -- â”‚   â”‚ compte â”‚ montant â”‚ client  â”‚                                        â”‚
    -- â”‚   â”‚   A    â”‚  100    â”‚  CLI1   â”‚                                        â”‚
    -- â”‚   â”‚   A    â”‚  150    â”‚  CLI1   â”‚                                        â”‚
    -- â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    INNER JOIN "cat_ap80414_ice"."AP01433_run_refined_view"."ap01433_f04_accounts" A 
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ ON : Condition de jointure (comment relier les 2 tables ?)              â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Condition 1 : O.p_i_uniq_cpt = A.account_source_unique_id               â”‚
    -- â”‚   â†’ Le numÃ©ro de compte dans les opÃ©rations doit correspondre           â”‚
    -- â”‚     au numÃ©ro de compte dans la table des comptes                       â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Condition 2 : SUBSTR(A.customer_source_unique_id, 1, 2) = '03'          â”‚
    -- â”‚   â†’ SUBSTR = "Substring" = Extraire une partie d'un texte              â”‚
    -- â”‚   â†’ SUBSTR(texte, position_dÃ©but, longueur)                             â”‚
    -- â”‚   â†’ SUBSTR("03ABC123", 1, 2) â†’ "03"                                     â”‚
    -- â”‚                                                                          â”‚
    -- â”‚   Les identifiants clients commenÃ§ant par "03" sont les ENTREPRISES     â”‚
    -- â”‚   (les particuliers auraient un autre prÃ©fixe, ex: "01")                â”‚
    -- â”‚                                                                          â”‚
    -- â”‚   C'est un FILTRE MÃ‰TIER : on ne veut que les clients entreprises       â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ON (
        O.p_i_uniq_cpt = A.account_source_unique_id   -- MÃªme numÃ©ro de compte
        AND SUBSTR(A.customer_source_unique_id, 1, 2) = '03'  -- Seulement entreprises
    )
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ WHERE : Filtre sur les donnÃ©es                                          â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ date_add('day', -365, CURRENT_DATE) :                                   â”‚
    -- â”‚   â†’ CURRENT_DATE = La date d'aujourd'hui (ex: 2024-12-20)               â”‚
    -- â”‚   â†’ date_add('day', -365, ...) = Soustraire 365 jours                   â”‚
    -- â”‚   â†’ RÃ©sultat : La date d'il y a 1 an (ex: 2023-12-20)                   â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ extract_date >= date d'il y a 1 an                                      â”‚
    -- â”‚   â†’ On ne garde que les opÃ©rations de la DERNIÃˆRE ANNÃ‰E                 â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Pourquoi 365 jours ? Pour avoir suffisamment d'historique               â”‚
    -- â”‚ (on filtrera ensuite sur les 7 derniers mois)                           â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    WHERE extract_date >= date_add('day', -365, CURRENT_DATE)
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ LIMIT : Limiter le nombre de rÃ©sultats                                  â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ âš ï¸ ATTENTION : C'est une MAUVAISE PRATIQUE en production !              â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ LIMIT 100000 = Maximum 100 000 lignes retournÃ©es                        â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ ProblÃ¨mes :                                                             â”‚
    -- â”‚   - Si on a 150 000 opÃ©rations, on en perd 50 000 !                     â”‚
    -- â”‚   - Les donnÃ©es sont tronquÃ©es de maniÃ¨re arbitraire                    â”‚
    -- â”‚   - Le modÃ¨le ML aura des donnÃ©es incomplÃ¨tes                           â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Cette limite existe probablement pour des tests/dÃ©veloppement           â”‚
    -- â”‚ En production, il faudrait la retirer ou l'augmenter considÃ©rablement   â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    LIMIT 100000
    
),  -- â† Virgule importante ! Elle sÃ©pare les diffÃ©rents "WITH"


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ Ã‰TAPE 2 : CrÃ©ation de la liste des 7 derniers mois "list_month"           â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

list_month AS (
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ SELECT DISTINCT : SÃ©lectionner les valeurs UNIQUES                      â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Sans DISTINCT :          Avec DISTINCT :                                â”‚
    -- â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
    -- â”‚ â”‚ 202403   â”‚             â”‚ 202403   â”‚                                   â”‚
    -- â”‚ â”‚ 202403   â”‚      â†’      â”‚ 202402   â”‚                                   â”‚
    -- â”‚ â”‚ 202402   â”‚             â”‚ 202401   â”‚                                   â”‚
    -- â”‚ â”‚ 202403   â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
    -- â”‚ â”‚ 202401   â”‚                                                            â”‚
    -- â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ On veut la liste des mois DIFFÃ‰RENTS, pas les doublons                  â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    SELECT DISTINCT month_year
    FROM operations_transformed  -- On utilise la table crÃ©Ã©e Ã  l'Ã©tape 1 !
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ ORDER BY ... DESC : Trier par ordre dÃ©croissant                         â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ DESC = Descending = Du plus grand au plus petit                         â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Exemple :                                                               â”‚
    -- â”‚   "202412" (dÃ©cembre 2024) â† Le plus rÃ©cent en premier                  â”‚
    -- â”‚   "202411" (novembre 2024)                                              â”‚
    -- â”‚   "202410" (octobre 2024)                                               â”‚
    -- â”‚   ...                                                                   â”‚
    -- â”‚   "202401" (janvier 2024) â† Le plus ancien en dernier                   â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ORDER BY month_year DESC
    
    -- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    -- â”‚ LIMIT 7 : Garder seulement les 7 premiers rÃ©sultats                     â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Comme on a triÃ© par ordre dÃ©croissant (DESC), les 7 premiers sont       â”‚
    -- â”‚ les 7 MOIS LES PLUS RÃ‰CENTS                                             â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Exemple (si on est en dÃ©cembre 2024) :                                  â”‚
    -- â”‚   1. "202412" (dÃ©cembre 2024)                                           â”‚
    -- â”‚   2. "202411" (novembre 2024)                                           â”‚
    -- â”‚   3. "202410" (octobre 2024)                                            â”‚
    -- â”‚   4. "202409" (septembre 2024)                                          â”‚
    -- â”‚   5. "202408" (aoÃ»t 2024)                                               â”‚
    -- â”‚   6. "202407" (juillet 2024)                                            â”‚
    -- â”‚   7. "202406" (juin 2024)  â† On s'arrÃªte lÃ                              â”‚
    -- â”‚                                                                          â”‚
    -- â”‚ Pourquoi 7 mois ? Pour calculer des agrÃ©gations sur 6 mois glissants    â”‚
    -- â”‚ (le 7Ã¨me mois permet d'avoir un historique complet)                     â”‚
    -- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    LIMIT 7
    
)  -- â† Pas de virgule ici car c'est le dernier WITH


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ Ã‰TAPE 3 : RequÃªte principale - Filtrer les opÃ©rations des 7 derniers mois â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ SELECT * : RÃ©cupÃ©rer toutes les colonnes                                    â”‚
-- â”‚ FROM operations_transformed : Depuis notre table temporaire de l'Ã©tape 1    â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
SELECT *
FROM operations_transformed

-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ WHERE ... IN (SELECT ...) : Sous-requÃªte de filtrage                        â”‚
-- â”‚                                                                              â”‚
-- â”‚ C'est comme demander :                                                      â”‚
-- â”‚ "Donne-moi les opÃ©rations dont le mois est DANS la liste des 7 derniers"   â”‚
-- â”‚                                                                              â”‚
-- â”‚ Ã‰quivalent en pseudo-code :                                                 â”‚
-- â”‚                                                                              â”‚
-- â”‚   liste_7_mois = ["202412", "202411", "202410", "202409",                   â”‚
-- â”‚                   "202408", "202407", "202406"]                             â”‚
-- â”‚                                                                              â”‚
-- â”‚   for operation in operations_transformed:                                  â”‚
-- â”‚       if operation.month_year in liste_7_mois:                              â”‚
-- â”‚           garder(operation)                                                 â”‚
-- â”‚                                                                              â”‚
-- â”‚ RÃ©sultat : Toutes les opÃ©rations bancaires des 7 derniers mois              â”‚
-- â”‚            pour les clients entreprises (prÃ©fixe "03")                      â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
WHERE month_year IN (SELECT month_year FROM list_month)


-- ============================================================================
-- ğŸ“Š RÃ‰SUMÃ‰ DE LA REQUÃŠTE
-- ============================================================================
--
-- ENTRÃ‰E :
--   - Table des mouvements bancaires (v_hsta92b0_detail)
--   - Table des comptes clients (ap01433_f04_accounts)
--
-- FILTRES APPLIQUÃ‰S :
--   1. Seulement les clients ENTREPRISES (customer_id commence par "03")
--   2. Seulement les opÃ©rations de la derniÃ¨re annÃ©e
--   3. Seulement les 7 derniers mois disponibles
--   4. Maximum 100 000 lignes (âš ï¸ limite potentiellement problÃ©matique)
--
-- COLONNES AJOUTÃ‰ES :
--   - year       : AnnÃ©e de l'opÃ©ration (ex: "2024")
--   - month      : Mois de l'opÃ©ration (ex: "3")
--   - day        : Jour de l'opÃ©ration (ex: "15")
--   - month_padded : Mois avec zÃ©ro (ex: "03")
--   - month_year : Identifiant annÃ©e-mois (ex: "202403")
--
-- SORTIE :
--   ~70 colonnes avec toutes les infos des opÃ©rations bancaires
--   UtilisÃ©es ensuite pour calculer des features de risque (turnover, coÃ»ts, etc.)
--
-- ============================================================================


-- ============================================================================
-- ğŸ“ CONCEPTS SQL APPRIS DANS CETTE REQUÃŠTE
-- ============================================================================
--
-- 1. WITH (CTE)     : CrÃ©er des tables temporaires rÃ©utilisables
-- 2. CAST           : Convertir un type de donnÃ©es en un autre
-- 3. YEAR/MONTH/DAY : Extraire des parties d'une date
-- 4. LPAD           : Ajouter des caractÃ¨res Ã  gauche d'un texte
-- 5. CONCAT         : Coller des textes ensemble
-- 6. INNER JOIN     : Fusionner deux tables sur une condition
-- 7. SUBSTR         : Extraire une partie d'un texte
-- 8. WHERE          : Filtrer les rÃ©sultats
-- 9. date_add       : Ajouter/soustraire des jours Ã  une date
-- 10. CURRENT_DATE  : Obtenir la date du jour
-- 11. DISTINCT      : Ã‰liminer les doublons
-- 12. ORDER BY DESC : Trier du plus grand au plus petit
-- 13. LIMIT         : Limiter le nombre de rÃ©sultats
-- 14. IN (SELECT)   : Filtrer avec une sous-requÃªte
--
-- ============================================================================
